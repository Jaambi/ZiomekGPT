const OPENAI_API_KEY=process.env.OPENAI_API_KEY,OPENAI='https://api.openai.com/v1';exports.handler=async e=>{try{const t=(e.path||'').replace(/^\/\.netlify\/functions\/ziomek/,''),n=e.httpMethod||'GET';if(!OPENAI_API_KEY)return s(500,{error:'OPENAI_API_KEY missing'});if(t.startsWith('/chat')&&'POST'===n)return await a(e);if(t.startsWith('/image')&&'POST'===n)return await i(e);if(t.startsWith('/tts')&&'POST'===n)return await o(e);if(t.startsWith('/transcribe')&&'POST'===n)return await r(e);return s(200,{ok:!0})}catch(e){return s(500,{error:String(e&&e.message||e)})}};function s(e,t){return{statusCode:e,headers:{'Content-Type':'application/json'},body:JSON.stringify(t)}}async function a(e){const t=JSON.parse(e.body||'{}'),n=[{role:'system',content:t.system||'Jeste≈õ Ziomek GPT.'},{role:'user',content:t.text||''}],a=await fetch(OPENAI+'/chat/completions',{method:'POST',headers:{Authorization:'Bearer '+OPENAI_API_KEY,'Content-Type':'application/json'},body:JSON.stringify({model:'gpt-4o',messages:n,temperature:.3})});if(!a.ok)return s(a.status,{error:await a.text()});const i=await a.json();return s(200,{text:i.choices?.[0]?.message?.content||''})}async function i(e){const{prompt:t='futurystyczny mentor biznesu',size:n='1024x1024'}=JSON.parse(e.body||'{}'),a=await fetch(OPENAI+'/images/generations',{method:'POST',headers:{Authorization:'Bearer '+OPENAI_API_KEY,'Content-Type':'application/json'},body:JSON.stringify({model:'gpt-image-1',prompt:t,size:n})});if(!a.ok)return s(a.status,{error:await a.text()});const i=await a.json(),o=i.data?.[0]?.b64_json;return o?s(200,{url:'data:image/png;base64,'+o}):s(500,{error:'no_image'})}async function o(e){const{text:t='Witaj',voice:n='alloy'}=JSON.parse(e.body||'{}'),a=await fetch(OPENAI+'/audio/speech',{method:'POST',headers:{Authorization:'Bearer '+OPENAI_API_KEY,'Content-Type':'application/json'},body:JSON.stringify({model:'gpt-4o-mini-tts',voice:n,input:t,format:'mp3'})});if(!a.ok)return s(a.status,{error:await a.text()});const i=Buffer.from(await a.arrayBuffer());return{statusCode:200,headers:{'Content-Type':'audio/mpeg'},body:i.toString('base64'),isBase64Encoded:!0}}async function r(e){const t=Buffer.from(e.body||'',e.isBase64Encoded?'base64':'binary'),n='----ziomek'+Math.random().toString(16).slice(2),a=[];function i(e,t,i,o){if(a.push(Buffer.from(`--${n}\r\n`)),i)a.push(Buffer.from(`Content-Disposition: form-data; name="${e}"; filename="${i}"\r\nContent-Type: ${o}\r\n\r\n`)),a.push(t),a.push(Buffer.from(`\r\n`));else a.push(Buffer.from(`Content-Disposition: form-data; name="${e}"\r\n\r\n${t}\r\n`))}i('model','whisper-1'),i('file',t,'audio.webm','audio/webm'),a.push(Buffer.from(`--${n}--`));const o=await fetch(OPENAI+'/audio/transcriptions',{method:'POST',headers:{Authorization:'Bearer '+OPENAI_API_KEY,'Content-Type':'multipart/form-data; boundary='+n},body:Buffer.concat(a)});if(!o.ok)return s(o.status,{error:await o.text()});const r=await o.json();return s(200,{text:r.text||''})}
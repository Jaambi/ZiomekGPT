const chatEl=document.getElementById('chat'),userInput=document.getElementById('userInput'),sendBtn=document.getElementById('sendBtn'),imgBtn=document.getElementById('imgBtn'),micBtn=document.getElementById('micBtn'),clearBtn=document.getElementById('clearBtn'),modeEl=document.getElementById('mode'),ttsToggle=document.getElementById('ttsToggle');function addMsg(e,t){const n=document.createElement('div');n.className='message '+('user'===e?'user':'bot'),n.innerHTML=`<div class="meta">${'user'===e?'Ty':'Ziomek'}</div>`+escapeHtml(t),chatEl.appendChild(n),chatEl.scrollTop=chatEl.scrollHeight}function addImg(e){const t=document.createElement('div');t.className='message bot',t.innerHTML=`<div class="meta">Ziomek</div><img src="${e}" alt="image" style="max-width:100%;border-radius:10px;border:1px solid #d0d0d0">`,chatEl.appendChild(t),chatEl.scrollTop=chatEl.scrollHeight}function escapeHtml(e=''){return e.replace(/[&<>]/g,(e=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[e])))}async function sendChat(){const e=userInput.value.trim();if(!e)return;const t=modeEl.value,n=window.buildSystemPrompt(t),a=window.expandUserPrompt(e,t);addMsg('user',e),userInput.value='';try{const e=await fetch('/api/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({system:n,text:a,mode:t})});if(!e.ok)throw new Error(await e.text());const t=await e.json();addMsg('bot',t.text||'[brak odpowiedzi]'),(null==ttsToggle?void 0:ttsToggle.checked)&&speak(t.text||'')}catch(e){addMsg('bot','Błąd: '+e.message)}}async function genImage(){const e=userInput.value.trim()||'Futurystyczny mentor biznesu, realistyczny portret, wysoki kontrast';addMsg('user','[Obraz] '+e);try{const t=await fetch('/api/image',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({prompt:e,size:'1024x1024'})});if(!t.ok)throw new Error(await t.text());const n=await t.json();n.url?addImg(n.url):addMsg('bot','Błąd generacji obrazu')}catch(e){addMsg('bot','Błąd: '+e.message)}}async function speak(e){try{if('speechSynthesis'in window){const t=new SpeechSynthesisUtterance(e);return t.lang='pl-PL',void speechSynthesis.speak(t)}const t=await fetch('/api/tts',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text:e})});if(!t.ok)return;const n=await t.arrayBuffer(),a=URL.createObjectURL(new Blob([n],{type:'audio/mpeg'}));new Audio(a).play()}catch{}}let rec=null,chunks=[];async function toggleMic(){if(rec&&'recording'===rec.state)return void rec.stop();const e=await navigator.mediaDevices.getUserMedia({audio:!0});rec=new MediaRecorder(e),chunks=[],rec.ondataavailable=e=>{e.data.size&&chunks.push(e.data)},rec.onstop=async()=>{const e=new Blob(chunks,{type:'audio/webm'}),t=await e.arrayBuffer(),n=await fetch('/api/transcribe',{method:'POST',body:t}),a=await n.json().catch((()=>({})));a&&a.text&&(userInput.value=(userInput.value?userInput.value+' ':'')+a.text)},rec.start()}sendBtn.addEventListener('click',sendChat),imgBtn.addEventListener('click',genImage),micBtn.addEventListener('click',toggleMic),clearBtn.addEventListener('click',(()=>chatEl.innerHTML='')),userInput.addEventListener('keydown',(e=>{'Enter'===e.key&&!e.shiftKey&&(e.preventDefault(),sendChat())}));